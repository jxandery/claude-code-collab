#!/bin/bash

# Claude Code Collaboration - Interactive Wizard
# Makes it easy for non-technical users to start collaborating

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

CONFIG_FILE="$HOME/.claude-collab-config"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Helper functions
print_header() {
    echo ""
    echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║  Claude Code Collaboration - Interactive Setup       ║${NC}"
    echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_step() {
    echo ""
    echo -e "${BOLD}$1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Load existing config if it exists
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        return 0
    fi
    return 1
}

# Save config
save_config() {
    cat > "$CONFIG_FILE" << EOF
# Claude Code Collaboration Configuration
# Generated by start-collaboration.sh

COLLAB_USER_NAME="$COLLAB_USER_NAME"
COLLAB_HOST="$COLLAB_HOST"
COLLAB_REMOTE_USER="$COLLAB_REMOTE_USER"
COLLAB_SESSION="$COLLAB_SESSION"
COLLAB_MODE="$COLLAB_MODE"
EOF
    chmod 600 "$CONFIG_FILE"
    print_success "Configuration saved to $CONFIG_FILE"
}

# Validate IP address
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    fi
    # Also allow hostnames
    if [[ $ip =~ ^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$ ]]; then
        return 0
    fi
    return 1
}

# Test SSH connection
test_ssh_connection() {
    local user=$1
    local host=$2

    print_info "Testing SSH connection to ${user}@${host}..."

    if ssh -o BatchMode=yes -o ConnectTimeout=5 "${user}@${host}" exit 2>/dev/null; then
        print_success "SSH connection successful!"
        return 0
    else
        print_warning "SSH connection failed with key authentication"
        print_info "Trying with password authentication..."

        if ssh -o ConnectTimeout=5 "${user}@${host}" exit; then
            print_success "SSH connection successful with password!"
            print_warning "Consider setting up SSH keys for password-less access"
            return 0
        else
            print_error "Could not connect to server"
            return 1
        fi
    fi
}

# Check if tmux session exists
check_session_exists() {
    local user=$1
    local host=$2
    local session=$3

    if ssh -o BatchMode=yes -o ConnectTimeout=5 "${user}@${host}" "tmux has-session -t ${session} 2>/dev/null"; then
        return 0
    fi
    return 1
}

# Main wizard
print_header

# Check if config exists
if load_config; then
    print_info "Found existing configuration:"
    echo ""
    echo -e "  ${BOLD}Name:${NC}         $COLLAB_USER_NAME"
    echo -e "  ${BOLD}Server:${NC}       $COLLAB_HOST"
    echo -e "  ${BOLD}User:${NC}         $COLLAB_REMOTE_USER"
    echo -e "  ${BOLD}Session:${NC}      $COLLAB_SESSION"
    echo -e "  ${BOLD}Mode:${NC}         $COLLAB_MODE"
    echo ""
    read -p "Use this configuration? [Y/n]: " use_existing

    if [[ ! $use_existing =~ ^[Nn] ]]; then
        USE_EXISTING=true
    else
        USE_EXISTING=false
    fi
else
    USE_EXISTING=false
fi

# Gather configuration
if [ "$USE_EXISTING" = false ]; then
    print_step "Step 1: Choose Your Role"
    echo "Are you:"
    echo "  1) Host (creating a new session)"
    echo "  2) Collaborator (joining an existing session)"
    echo ""
    read -p "Enter choice [1 or 2]: " role_choice

    case $role_choice in
        1)
            ROLE="host"
            print_info "You selected: Host"
            ;;
        2)
            ROLE="collaborator"
            print_info "You selected: Collaborator"
            ;;
        *)
            print_error "Invalid choice. Exiting."
            exit 1
            ;;
    esac

    print_step "Step 2: Your Information"

    # Get username
    if [ -n "$COLLAB_USER_NAME" ]; then
        read -p "Your name [$COLLAB_USER_NAME]: " input_name
        COLLAB_USER_NAME="${input_name:-$COLLAB_USER_NAME}"
    else
        default_name=$(whoami)
        read -p "Your name [$default_name]: " input_name
        COLLAB_USER_NAME="${input_name:-$default_name}"
    fi

    print_step "Step 3: Server Information"

    # Get server IP
    while true; do
        if [ -n "$COLLAB_HOST" ]; then
            read -p "Server IP or hostname [$COLLAB_HOST]: " input_host
            COLLAB_HOST="${input_host:-$COLLAB_HOST}"
        else
            read -p "Server IP or hostname (e.g., 68.183.159.246): " COLLAB_HOST
        fi

        if validate_ip "$COLLAB_HOST"; then
            print_success "Valid server address"
            break
        else
            print_error "Invalid IP address or hostname. Please try again."
        fi
    done

    # Get remote username
    if [ -n "$COLLAB_REMOTE_USER" ]; then
        read -p "Server username [$COLLAB_REMOTE_USER]: " input_user
        COLLAB_REMOTE_USER="${input_user:-$COLLAB_REMOTE_USER}"
    else
        read -p "Server username (e.g., claudeteam): " COLLAB_REMOTE_USER
    fi

    # Get session name
    if [ -n "$COLLAB_SESSION" ]; then
        read -p "Session name [$COLLAB_SESSION]: " input_session
        COLLAB_SESSION="${input_session:-$COLLAB_SESSION}"
    else
        read -p "Session name [claude-collab]: " input_session
        COLLAB_SESSION="${input_session:-claude-collab}"
    fi

    print_step "Step 4: Choose Interface Mode"
    echo "Which mode do you prefer?"
    echo "  1) Split-pane mode (recommended) - Shows Claude output + your input in one window"
    echo "  2) Simple mode - Just input terminal, view output separately"
    echo ""
    read -p "Enter choice [1 or 2]: " mode_choice

    case $mode_choice in
        1)
            COLLAB_MODE="split"
            print_info "You selected: Split-pane mode"
            ;;
        2)
            COLLAB_MODE="simple"
            print_info "You selected: Simple mode"
            ;;
        *)
            COLLAB_MODE="split"
            print_warning "Invalid choice. Defaulting to split-pane mode"
            ;;
    esac

    # Test SSH connection
    print_step "Step 5: Testing Connection"

    if ! test_ssh_connection "$COLLAB_REMOTE_USER" "$COLLAB_HOST"; then
        print_error "Cannot connect to server. Please check:"
        echo "  - Server IP/hostname is correct"
        echo "  - Server is running"
        echo "  - SSH access is configured"
        echo "  - Your network allows SSH connections"
        echo ""
        read -p "Continue anyway? [y/N]: " continue_anyway
        if [[ ! $continue_anyway =~ ^[Yy] ]]; then
            exit 1
        fi
    fi

    # Save configuration
    print_step "Step 6: Save Configuration"
    read -p "Save this configuration for future use? [Y/n]: " save_config_choice

    if [[ ! $save_config_choice =~ ^[Nn] ]]; then
        save_config
    fi
else
    # Using existing config, but still ask for role
    print_step "Choose Your Role"
    echo "Are you:"
    echo "  1) Host (creating/managing a session)"
    echo "  2) Collaborator (joining an existing session)"
    echo ""
    read -p "Enter choice [1 or 2]: " role_choice

    case $role_choice in
        1)
            ROLE="host"
            ;;
        2)
            ROLE="collaborator"
            ;;
        *)
            print_error "Invalid choice. Exiting."
            exit 1
            ;;
    esac
fi

# Summary
print_step "Summary"
echo -e "  ${BOLD}Role:${NC}         $ROLE"
echo -e "  ${BOLD}Name:${NC}         $COLLAB_USER_NAME"
echo -e "  ${BOLD}Server:${NC}       $COLLAB_HOST"
echo -e "  ${BOLD}User:${NC}         $COLLAB_REMOTE_USER"
echo -e "  ${BOLD}Session:${NC}      $COLLAB_SESSION"
echo -e "  ${BOLD}Mode:${NC}         $COLLAB_MODE"
echo ""

# Host-specific actions
if [ "$ROLE" = "host" ]; then
    # Check if session already exists
    print_info "Checking if session exists..."

    if check_session_exists "$COLLAB_REMOTE_USER" "$COLLAB_HOST" "$COLLAB_SESSION"; then
        print_warning "Session '$COLLAB_SESSION' already exists on the server"
        echo ""
        echo "Options:"
        echo "  1) Join existing session"
        echo "  2) Kill and recreate session"
        echo "  3) Cancel"
        echo ""
        read -p "Enter choice [1, 2, or 3]: " session_action

        case $session_action in
            1)
                print_info "Joining existing session..."
                ;;
            2)
                print_info "Killing existing session..."
                ssh "${COLLAB_REMOTE_USER}@${COLLAB_HOST}" "tmux kill-session -t ${COLLAB_SESSION}"
                print_success "Session killed"

                print_info "Creating new session on server..."
                print_warning "You'll need to start Claude Code manually after connecting"
                print_info "Run these commands:"
                echo ""
                echo "  1. SSH to server: ssh ${COLLAB_REMOTE_USER}@${COLLAB_HOST}"
                echo "  2. Create session: tmux new-session -s ${COLLAB_SESSION}"
                echo "  3. Start Claude Code: claude-code"
                echo "  4. Detach: Ctrl+B, then D"
                echo "  5. Exit: exit"
                echo ""
                read -p "Press Enter when you've completed these steps..."
                ;;
            3)
                print_info "Cancelled"
                exit 0
                ;;
            *)
                print_error "Invalid choice. Exiting."
                exit 1
                ;;
        esac
    else
        print_info "No existing session found"
        print_warning "You need to create the session first!"
        echo ""
        echo "Follow these steps:"
        echo ""
        echo "  1. SSH to server: ssh ${COLLAB_REMOTE_USER}@${COLLAB_HOST}"
        echo "  2. Create session: tmux new-session -s ${COLLAB_SESSION}"
        echo "  3. Start Claude Code: claude-code"
        echo "  4. Wait for Claude to load"
        echo "  5. Detach: Press Ctrl+B, then D"
        echo "  6. Exit: exit"
        echo ""
        read -p "Press Enter when you've completed these steps..."
    fi
fi

# Launch appropriate script
print_step "Starting Collaboration"

if [ "$COLLAB_MODE" = "split" ]; then
    SCRIPT="${SCRIPT_DIR}/join-claude-session-split.sh"
    if [ ! -f "$SCRIPT" ]; then
        print_error "Split-pane script not found: $SCRIPT"
        print_info "Run './install.sh' to install scripts"
        exit 1
    fi

    print_info "Launching split-pane mode..."
    exec "$SCRIPT" "$COLLAB_USER_NAME" "$COLLAB_HOST" "$COLLAB_REMOTE_USER" "$COLLAB_SESSION"
else
    print_info "Launching simple mode..."
    print_info "Connecting to server..."

    ssh -t "${COLLAB_REMOTE_USER}@${COLLAB_HOST}" \
        "join-claude-session.sh '$COLLAB_USER_NAME' '$COLLAB_SESSION'"
fi
